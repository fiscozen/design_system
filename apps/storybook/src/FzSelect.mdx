import { Meta } from '@storybook/addon-docs/blocks';

<Meta title="Documentation/Form/FzSelect" />

# FzSelect

A dropdown select component with floating panel, lazy loading, keyboard navigation, and full accessibility support.

## Features

- Dropdown selection with floating panel positioning
- Lazy loading for performance with large option lists
- Grouped options with label separators
- Custom icons (left and right positions)
- Error and help states with custom slots
- Floating label variant for compact forms
- Keyboard navigation with full ARIA support
- WCAG 2.1 AA compliant accessibility

## Installation

```bash
npm install @fiscozen/select
```

## Basic Usage

```vue
<script setup>
import { ref } from 'vue'
import { FzSelect } from '@fiscozen/select'

const selectedValue = ref('')

const options = [
  { value: '1', label: 'Option 1' },
  { value: '2', label: 'Option 2' },
  { value: '3', label: 'Option 3' }
]
</script>

<template>
  <FzSelect
    v-model="selectedValue"
    :options="options"
    label="Select an option"
    placeholder="Choose..."
    environment="frontoffice"
  />
</template>
```

## Props

<table>
  <thead>
    <tr>
      <th>Prop</th>
      <th>Type</th>
      <th>Default</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>options</code></td>
      <td><code>FzSelectOptionsProps[]</code></td>
      <td><strong>required</strong></td>
      <td>List of options to display in the dropdown</td>
    </tr>
    <tr>
      <td><code>label</code></td>
      <td><code>string</code></td>
      <td>-</td>
      <td>Label displayed above the select input</td>
    </tr>
    <tr>
      <td><code>placeholder</code></td>
      <td><code>string</code></td>
      <td>-</td>
      <td>Placeholder text shown when no option is selected</td>
    </tr>
    <tr>
      <td><code>required</code></td>
      <td><code>boolean</code></td>
      <td><code>false</code></td>
      <td>Marks the select as required (shows asterisk)</td>
    </tr>
    <tr>
      <td><code>disabled</code></td>
      <td><code>boolean</code></td>
      <td><code>false</code></td>
      <td>Disables the select input</td>
    </tr>
    <tr>
      <td><code>readonly</code></td>
      <td><code>boolean</code></td>
      <td><code>false</code></td>
      <td>Makes the select readonly (same visual style as disabled)</td>
    </tr>
    <tr>
      <td><code>error</code></td>
      <td><code>boolean</code></td>
      <td><code>false</code></td>
      <td>Shows error state styling</td>
    </tr>
    <tr>
      <td><code>environment</code></td>
      <td><code>'backoffice' | 'frontoffice'</code></td>
      <td><code>'frontoffice'</code></td>
      <td>Environment context for styling (affects button height and text size)</td>
    </tr>
    <tr>
      <td><code>clearable</code></td>
      <td><code>boolean</code></td>
      <td><code>true</code></td>
      <td>Allows clearing the selected value by clicking the selected option again</td>
    </tr>
    <tr>
      <td><code>noResultsMessage</code></td>
      <td><code>string</code></td>
      <td><code>'Nessun risultato trovato'</code></td>
      <td>Message displayed when no options are available</td>
    </tr>
    <tr>
      <td><code>size</code></td>
      <td><code>'sm' | 'md' | 'lg'</code></td>
      <td><code>'md'</code></td>
      <td><strong>Deprecated:</strong> Size prop is deprecated. The component now uses a fixed 'lg' size. This prop will be removed in a future version.</td>
    </tr>
    <tr>
      <td><code>leftIcon</code></td>
      <td><code>string</code></td>
      <td>-</td>
      <td>Icon name to display on the left</td>
    </tr>
    <tr>
      <td><code>rightIcon</code></td>
      <td><code>string</code></td>
      <td>-</td>
      <td>Icon name to display on the right</td>
    </tr>
    <tr>
      <td><code>rightIconButton</code></td>
      <td><code>boolean</code></td>
      <td><code>false</code></td>
      <td>Renders right icon as a button instead of icon</td>
    </tr>
    <tr>
      <td><code>rightIconButtonVariant</code></td>
      <td><code>IconButtonVariant</code></td>
      <td>-</td>
      <td>Variant for right icon button</td>
    </tr>
    <tr>
      <td><code>rightIconLast</code></td>
      <td><code>boolean</code></td>
      <td><code>false</code></td>
      <td><strong>Deprecated:</strong> rightIconLast prop is deprecated. The right icon is now always positioned before the chevron. This prop will be removed in a future version.</td>
    </tr>
    <tr>
      <td><code>pickerClass</code></td>
      <td><code>string</code></td>
      <td>-</td>
      <td>Custom CSS classes for the picker button</td>
    </tr>
    <tr>
      <td><code>variant</code></td>
      <td><code>'normal' | 'floating-label'</code></td>
      <td><code>'normal'</code></td>
      <td>Select variant style</td>
    </tr>
    <tr>
      <td><code>optionsToShow</code></td>
      <td><code>number</code></td>
      <td><code>25</code></td>
      <td>Number of options to render per batch (lazy loading)</td>
    </tr>
    <tr>
      <td><code>floatingPanelMaxHeight</code></td>
      <td><code>string</code></td>
      <td>-</td>
      <td>Maximum height for the floating panel</td>
    </tr>
    <tr>
      <td><code>disableTruncate</code></td>
      <td><code>boolean</code></td>
      <td><code>false</code></td>
      <td>Disables text truncation in options</td>
    </tr>
    <tr>
      <td><code>extOpener</code></td>
      <td><code>HTMLElement</code></td>
      <td>-</td>
      <td>External element to use as opener</td>
    </tr>
    <tr>
      <td><code>position</code></td>
      <td><code>FzFloatingPosition</code></td>
      <td><code>'auto-vertical-start'</code></td>
      <td>Floating panel position</td>
    </tr>
    <tr>
      <td><code>teleport</code></td>
      <td><code>boolean</code></td>
      <td><code>true</code></td>
      <td>Teleport panel to body</td>
    </tr>
    <tr>
      <td><code>useViewport</code></td>
      <td><code>boolean</code></td>
      <td><code>true</code></td>
      <td>Use viewport constraints for positioning</td>
    </tr>
  </tbody>
</table>

## Slots

<table>
  <thead>
    <tr>
      <th>Slot</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>opener</code></td>
      <td>Custom opener button (receives <code>handlePickerClick</code>, <code>isOpen</code>, <code>floating</code> props)</td>
    </tr>
    <tr>
      <td><code>error</code></td>
      <td>Error message content (shown when <code>error={true}</code>)</td>
    </tr>
    <tr>
      <td><code>help</code></td>
      <td>Help text content (shown when no error)</td>
    </tr>
  </tbody>
</table>

## Examples

### Basic Select

```vue
<template>
  <FzSelect
    v-model="selected"
    :options="options"
    label="Country"
    placeholder="Select a country"
  />
</template>
```

### With Icons

```vue
<template>
  <FzSelect
    v-model="selected"
    :options="options"
    label="Search"
    leftIcon="magnifying-glass"
    rightIcon="xmark"
    :rightIconButton="true"
    @fzselect:right-icon-click="clearSelection"
  />
</template>
```

### Grouped Options

```vue
<template>
  <FzSelect
    v-model="selected"
    :options="groupedOptions"
    label="Category"
  />
</template>

<script setup>
const groupedOptions = [
  { kind: 'label', label: 'Fruits' },
  { value: 'apple', label: 'Apple' },
  { value: 'banana', label: 'Banana' },
  { kind: 'label', label: 'Vegetables' },
  { value: 'carrot', label: 'Carrot' },
  { value: 'lettuce', label: 'Lettuce' }
]
</script>
```

### Error State

```vue
<template>
  <FzSelect
    v-model="selected"
    :options="options"
    label="Required Field"
    :required="true"
    :error="hasError"
  >
    <template #error>
      Please select an option
    </template>
  </FzSelect>
</template>
```

### Help Text

```vue
<template>
  <FzSelect
    v-model="selected"
    :options="options"
    label="Select"
  >
    <template #help>
      Choose the best option for your needs
    </template>
  </FzSelect>
</template>
```

### Floating Label Variant

```vue
<template>
  <FzSelect
    v-model="selected"
    :options="options"
    variant="floating-label"
    placeholder="Select..."
    environment="frontoffice"
  />
</template>
```

### Environment Styling

The component supports two environments with different styling:

```vue
<template>
  <!-- Backoffice: 32px height -->
  <FzSelect
    v-model="selected"
    :options="options"
    environment="backoffice"
    label="Backoffice Select"
  />
  
  <!-- Frontoffice: 44px height -->
  <FzSelect
    v-model="selected"
    :options="options"
    environment="frontoffice"
    label="Frontoffice Select"
  />
</template>
```

### Readonly State

```vue
<template>
  <FzSelect
    v-model="selected"
    :options="options"
    label="Readonly Select"
    readonly
  />
</template>
```

The `readonly` prop applies the same visual style as `disabled` (grey-100 background/border, grey-300 text) but maintains the same semantic meaning. Keyboard navigation is disabled when readonly.

### Disabled Options

```vue
<script setup>
const options = [
  { value: '1', label: 'Available' },
  { value: '2', label: 'Disabled', disabled: true },
  { value: '3', label: 'Read-only', readonly: true }
]
</script>
```

### Clearable Selection

```vue
<template>
  <FzSelect
    v-model="selected"
    :options="options"
    label="Clearable Select"
    :clearable="true"
  />
</template>
```

The `clearable` prop (default: `true`) allows users to deselect an option by clicking it again. Set to `false` to prevent clearing.

### Custom No Results Message

```vue
<template>
  <FzSelect
    v-model="selected"
    :options="filteredOptions"
    label="Search"
    noResultsMessage="No matches found. Try a different search term."
  />
</template>
```

## Accessibility

The component is fully accessible and WCAG 2.1 AA compliant:

- **Keyboard navigation**: Full keyboard support for opening, navigating, and selecting options
- **Screen reader support**: Proper ARIA attributes and live region announcements
- **Semantic HTML**: Uses `role="listbox"` and `role="option"` for proper semantics
- **Focus management**: Automatic focus handling on open/close with focus trap
- **State announcements**: Screen readers announce open/closed state, selected option, and focused option

### Keyboard Navigation

The component supports comprehensive keyboard navigation:

**Opener Button:**
- `Enter` / `Space`: Open dropdown (if closed) or close dropdown (if open)
- `Escape`: Close dropdown (if open)
- `Tab`: Move focus to next element
- `Shift+Tab`: Move focus to previous element

**Options Container (when dropdown is open):**
- `ArrowDown`: Move focus to next option (wraps to first on last option)
- `ArrowUp`: Move focus to previous option (wraps to last on first option)
- `Home`: Move focus to first option
- `End`: Move focus to last option
- `Enter` / `Space`: Select focused option and close dropdown
- `Escape`: Close dropdown without selecting
- `Tab`: Move focus to next option (wraps to first on last option) - focus trap active
- `Shift+Tab`: Move focus to previous option (wraps to last on first option) - focus trap active

**Readonly/Disabled States:**
- When `readonly` or `disabled` is `true`, keyboard navigation is disabled
- Focus trap is not active when component is readonly or disabled

### Focus Management

- **On open**: Focus automatically moves to first selectable option (or selected option if present)
- **On close**: Focus automatically returns to opener button
- **Focus trap**: When dropdown is open, Tab/Shift+Tab navigation is trapped within the options list
- **Dynamic updates**: Focus management handles prop changes (readonly/disabled) gracefully

### Screen Reader Support

The component provides rich semantic information to assistive technologies:

- **ARIA attributes**: All interactive elements have proper ARIA roles and states
- **Live announcements**: Screen readers announce focused option via `aria-activedescendant`
- **State changes**: Open/closed state and selection changes are announced
- **Label associations**: Proper `aria-labelledby` relationships for form integration

### ARIA Attributes

**Opener Button:**
- `aria-expanded`: Indicates dropdown open/closed state (`"true"` or `"false"`)
- `aria-haspopup="listbox"`: Declares dropdown type
- `aria-labelledby`: Links to label element (when label is provided)
- `aria-label`: Provides accessible name when label is not present
- `aria-required`: Indicates required fields (`"true"` or `"false"`)
- `aria-invalid`: Indicates error state (`"true"` or `"false"`)
- `aria-disabled`: Indicates disabled/readonly state (`"true"` or `"false"`)

**Options Container:**
- `role="listbox"`: Declares the container as a listbox
- `aria-labelledby`: Links to opener button for context
- `aria-activedescendant`: Points to currently focused option (dynamically updated)

**Option Elements (FzAction components):**
- `role="option"`: Declares each option as a listbox option
- `aria-selected`: Indicates selected option (`"true"` or `"false"`)
- `aria-disabled`: Indicates disabled/readonly option (`"true"` or `"false"`)
- Unique `id` attributes for `aria-activedescendant` reference
- `tabindex`: 0 when focused, -1 otherwise (for keyboard navigation)
- `focused`: Visual focus state managed by FzSelect

**Note:** Options are rendered using `FzAction` components from `@fiscozen/action`, which handle their own accessibility attributes and keyboard interactions. FzSelect manages the overall listbox behavior and focus state.
